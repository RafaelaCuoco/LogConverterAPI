# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: CI/CD Pipeline for .NET Project

# Define quando o workflow será acionado
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

# Define os jobs que serão executados
jobs:
  build:
    runs-on: ubuntu-20.04 # Ou ubuntu-18.04

    steps:
    # Passo 1: Fazer o checkout do código
    - name: Checkout code
      uses: actions/checkout@v3

    # Passo 2: Configurar o SDK do .NET
    - name: Install OpenSSL (libssl1.1)
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget http://security.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2.20_amd64.deb
        sudo dpkg -i libssl1.1_1.1.1f-1ubuntu2.20_amd64.deb
        sudo apt-get install -f -y

    - name: Download and Install .NET Core 2.1
      run: |
        wget https://download.visualstudio.microsoft.com/download/pr/8b5c479a-1e6f-4e7c-9d0b-8c8e9b9c6e4d/7c0b5b0b1b1b4b1b1b1b1b1b1b1b1b1b/dotnet-sdk-2.1.818-linux-x64.tar.gz
        mkdir -p $HOME/dotnet
        tar zxf dotnet-sdk-2.1.818-linux-x64.tar.gz -C $HOME/dotnet
        echo "$HOME/dotnet" >> $GITHUB_PATH

    - name: Verify .NET Installation
      run: dotnet --version
        
    # Passo 3: Cache NuGets
    - name: Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    # Passo 4: Restaurar as dependências
    - name: Restore dependencies
      run: dotnet restore

    # Passo 5: Compilar o projeto
    - name: Build project
      run: dotnet build --configuration Release --no-restore

    # Passo 6: Executar os testes
    - name: Run tests
      run: dotnet test --no-build --verbosity normal
    - name: Publish to GitHub Packages
      run: dotnet pack --configuration Release --output ./nupkg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Passo 7: Publicar o projeto (opcional)
    - name: Publish project
      if: github.ref == 'refs/heads/main' # Executa apenas na branch principal
      run: dotnet publish -c Release -o ./publish
